[Unit]
Description=Odoo initialization service
Documentation=https://www.odoo.com/documentation/

Requires=odoo-db.service
After=odoo-db.service
Before=odoo-app.service

# Prevent running if already initialized
ConditionPathExists=!/var/lib/odoo/initialized

[Container]
ContainerName=odoo-init
Image=docker.io/library/odoo:17

# Network configuration
Network=host
AddCapability=CAP_NET_BIND_SERVICE

# Environment variables from secrets and config
EnvironmentFile=/etc/containers/systemd/configs/odoo-config.env

# Volume mounts
Volume=/etc/odoo:/etc/odoo:ro
Volume=/var/lib/odoo/data:/var/lib/odoo:z
Volume=/var/lib/odoo/addons:/mnt/extra-addons:z
Volume=/var/log/odoo:/var/log/odoo:z

# Initialization script
Entrypoint=/bin/bash
Exec=/etc/odoo/init.sh

[Service]
Type=oneshot
Restart=no
RemainAfterExit=yes

# Flag this service as initialized
ExecStartPost=/bin/touch /var/lib/odoo/initialized

# Skaffold filesystem + fix permissions
ExecStartPre=install -m 0700 -o 101 -g 101 -d /var/lib/odoo/data /var/lib/odoo/addons /var/log/odoo

# Wait for PostgreSQL to be ready
ExecStartPre=/bin/sh -c 'exec 2>/dev/null; for try in $(seq 0 12); do if ! /bin/true 5<> /dev/tcp/127.0.0.1/5432; then echo "Waiting for PostgreSQL to be available..."; sleep 5; else exit 0; fi; done; exit 1'

[Install]
WantedBy=odoo.target
